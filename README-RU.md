# Minsk metro

Здесь собраны скрипты, которые нужны, чтобы построить карту пешеходной доступности Минского метрополитена.

# Аннонс

Как с помощью открытых сервисов получать информацию о жизни города? На примере построения карты пешеходной доступности станций Минского метрополитена, я покажу и объясню необходимые шаги, которые встречаются в исследованиях такого плана. Затрону вопросы от поиска и подготовки исходных данных до публикации итогового результата.

# Ход эксперимента

## Шаг один. Оцениваем масштаб проблемы

В качестве исходной карты я возьму OpenStreetMap. Но он покрывает весь мир и работа с полной картой может оказаться не удобной. Поэтому я буду использовать выгрузку. Это может оказаться не всегда удобным. Чтобы было легче ориентроваться, я вынесу плюсы и минусы этого подхода в список.

Плюсы использования чужой выгрузки карты OpenStreetMap:

 - Меньше качать из интернета
 - Быстрее обработка
 - Не надо разбираться с дополнительным софтом для нарезки файла

Минусы использования чужой выгрузки карты OpenStreetMap:

 - В выгрузке будут не самые новые данные карты
 - Нужная область может быть порезана
 - Для обновления карты нужно перекачивать всю выгрузку с 0

# Ищем нужную выгрузку:

Есть сайт http://download.geofabrik.de/ где можно найти выгрузки по странам. Есть так и Беларусь. На момент создания презентации, файл формата занимает 161мб. http://download.geofabrik.de/europe/belarus-latest.osm.pbf
Буду пользовтаься им, чтобы не грузить интернет соединение.

# Определение области в которой будем работать

На скачивании файла можно в принципе и остановтиться, но почти всегда файл покрывает гораздо большую область, чем нам нужно, поэтому предлагаю определить область в которой мы будем работать. Для этого воспользуемся сервисом overpass-turbo.eu
Но сначала давайте посмотрим что мы вообще ищем. Нам нужны входы в метро.
Начинаем искать гугл и первым делом натыкаюсь на пост Zveric о том как хорошо бы тегировать метро: http://wiki.openstreetmap.org/wiki/User:Zverik/%D0%9C%D0%B5%D1%82%D1%80%D0%BE
Но в Минске похоже ему не следуют. В любом случае, из поста узнаём, что вход в метро обозначается тегом `railway=subway_entrance`
Пробуем найти их всех на карте Минска.
Составляем запрос:
```
node
  [railway=subway_entrance]
  ({{bbox}});
out;
```
И получаем overpass-result. При ближайшем рассмотрении, допустим станции Первомайская, получаем pervomayskaya. Как видим, в Минске пропозал Zverik'a не соблюдается и все станции протегированы по входу. Но они соеденены с пешеходным графом (красные линии). Нас такой вариант вполне устраивает.

Дальше попробуем сделать довольно варварский метод обрезки, который всегда работает =) Заходим на сайт geojson.io и рисуем диагональ прямоугольника, который мы хотим захватить geojsonio. Из получившегося geojson выдёргиваем координаты, чтобы очертить bbox (совершенно не обязательно выдёргивать всё с точностью которую пишет сервис. Помните, что 6 знак после запятой влияет на 10ки сантиметров, а для нашей задачи подойдёт и пара знаков).

В итоге всё это выражается в задачу для утилиты osmconvert или osmium.
```
osmconvert -b=27.4,53.82,27.75,54.0 belarus-latest.osm.pbf --out-pbf > belarus-clipped.osm.pbf
```
После выполнения проверяем, что мы указали правильные координаты (итоговый файла не 0 размера). И видим, что исходные данные "похудели" до 11 мб. Уже не плохо.

# Подготовка OSRM
# Подготока БД

В скрипте запуска, обратите внимание на ключ -l потому что он сохраняет данные в исходных координатах. Это какраз подходит под наши нужды, но по-хорошему не удобно в остальных рассчётах. Поэтому по умолчанию, osm2pgsql будет преобразовывать в web mercator (3857).

В исходном стиле импорта сохраняется нужный нам класс текгов railway, поэтому нам остаётся только проверить что там хранится
```
postgres=# select distinct railway from planet_osm_point;
     railway
-----------------

 switch
 subway_entrance
 buffer_stop
 proposed
 traffic_signals
 level_crossing
 station
 tram_stop
 preserved
 halt
 crossing
 construction
(13 rows)
```
и использовать в своих проектах.

Проверка

```
select st_asgeojson(st_collect(way)) from planet_osm_point where railway='subway_entrance';
```

# Запросы
# Построение областей
# Публикация
